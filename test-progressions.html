<!DOCTYPE html>
<html>
<head>
    <title>Test Chord Progressions</title>
    <script src="music-theory.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 10px; font-size: 16px; }
        .test-results { margin: 20px 0; padding: 15px; background-color: #f0f0f0; border-radius: 5px; }
        .chord-list { list-style-type: none; padding: 0; }
        .chord-list li { padding: 5px; margin: 2px 0; background-color: #e0e0e0; border-radius: 3px; }
        .warning { color: orange; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Test Improved Chord Progressions</h1>
    <button onclick="testProgression('C', 'Major')">Test C Major</button>
    <button onclick="testProgression('Am', 'Minor')">Test A Minor</button>
    <button onclick="testAllChordTypes()">Test All Chord Types</button>
    <button onclick="testAdd9SpecialCase()">Test Add9 Special Case</button>
    <button onclick="testMultipleProgressions()">Test Multiple Progressions</button>
    <button onclick="testRepetitionAvoidance()">Test Repetition Avoidance</button>
    
    <div id="output"></div>

    <script>
        // Mock the required DOM functions for our test
        document.querySelectorAll = function(selector) {
            if (selector.includes('inversion')) {
                return [
                    { value: 'root' },
                    { value: 'first' },
                    { value: 'second' }
                ];
            }
            return [];
        };

        function testProgression(key, mode) {
            const selectedTypes = ['major', 'minor', 'dominant7', 'major7', 'minor7', 'diminished', 'half-diminished', 'augmented', 'sus2', 'sus4', 'add9'];
            const selectedInversions = ['root', 'first', 'second'];
            const length = 8;
            
            const progression = generateChordProgression(key, length, selectedTypes, selectedInversions, 'Random');
            
            let output = `<div class="test-results"><h2>${key} ${mode} Random Progression:</h2><ul class="chord-list">`;
            progression.forEach((chord, index) => {
                output += `<li>Chord ${index + 1}: ${chord.root} ${chord.type} (${chord.inversion}) - Scale Degree: ${chord.degreeIndex}</li>`;
            });
            output += '</ul></div>';
            
            document.getElementById('output').innerHTML = output;
        }

        function testAllChordTypes() {
            const selectedTypes = ['major', 'minor', 'dominant7', 'major7', 'minor7', 'diminished', 'half-diminished', 'augmented', 'sus2', 'sus4', 'add9'];
            const selectedInversions = ['root', 'first', 'second'];
            const length = 16;
            
            const progression = generateChordProgression('C', length, selectedTypes, selectedInversions, 'Random');
            
            // Count occurrences of each chord type
            const typeCount = {};
            progression.forEach(chord => {
                typeCount[chord.type] = (typeCount[chord.type] || 0) + 1;
            });
            
            let output = '<div class="test-results"><h2>All Chord Types Test:</h2>';
            output += '<h3>Generated Progression:</h3><ul class="chord-list">';
            progression.forEach((chord, index) => {
                output += `<li>Chord ${index + 1}: ${chord.root} ${chord.type} (${chord.inversion}) - Scale Degree: ${chord.degreeIndex}</li>`;
            });
            output += '</ul>';
            
            output += '<h3>Chord Type Distribution:</h3><ul>';
            Object.entries(typeCount).forEach(([type, count]) => {
                output += `<li>${type}: ${count} chord(s)</li>`;
            });
            output += '</ul></div>';
            
            document.getElementById('output').innerHTML = output;
        }

        function testAdd9SpecialCase() {
            // Test 1: Add9 with root, first, and second inversions selected
            let selectedTypes = ['major', 'add9'];
            let selectedInversions = ['root', 'first', 'second'];
            let length = 16;
            
            let progression = generateChordProgression('C', length, selectedTypes, selectedInversions, 'Random');
            
            // Check if add9 chords are only in first or second inversion
            let add9Chords = progression.filter(chord => chord.type === 'add9');
            let add9RootCount = add9Chords.filter(chord => chord.inversion === 'root').length;
            
            let output = '<div class="test-results"><h2>Add9 Special Case Test:</h2>';
            output += '<h3>Test 1: Add9 with all inversions selected</h3>';
            output += '<p>Generated progression:</p><ul class="chord-list">';
            progression.forEach((chord, index) => {
                output += `<li>Chord ${index + 1}: ${chord.root} ${chord.type} (${chord.inversion})</li>`;
            });
            output += '</ul>';
            
            if (add9RootCount === 0) {
                output += '<p class="success">✓ PASS: No add9 chords in root position</p>';
            } else {
                output += `<p class="warning">⚠ WARNING: ${add9RootCount} add9 chords found in root position</p>`;
            }
            
            // Test 2: Add9 with only root inversion selected (should not generate add9)
            selectedTypes = ['major', 'add9'];
            selectedInversions = ['root'];
            length = 16;
            
            progression = generateChordProgression('C', length, selectedTypes, selectedInversions, 'Random');
            
            // Check if add9 chords are generated at all
            add9Chords = progression.filter(chord => chord.type === 'add9');
            
            output += '<h3>Test 2: Add9 with only root inversion selected</h3>';
            output += '<p>Generated progression:</p><ul class="chord-list">';
            progression.forEach((chord, index) => {
                output += `<li>Chord ${index + 1}: ${chord.root} ${chord.type} (${chord.inversion})</li>`;
            });
            output += '</ul>';
            
            if (add9Chords.length === 0) {
                output += '<p class="success">✓ PASS: No add9 chords generated when only root inversion is selected</p>';
            } else {
                output += `<p class="warning">⚠ WARNING: ${add9Chords.length} add9 chords generated when only root inversion is selected</p>`;
            }
            
            // Test 3: Add9 with only first inversion selected
            selectedTypes = ['major', 'add9'];
            selectedInversions = ['first'];
            length = 16;
            
            progression = generateChordProgression('C', length, selectedTypes, selectedInversions, 'Random');
            
            // Check if add9 chords are only in first inversion
            add9Chords = progression.filter(chord => chord.type === 'add9');
            let add9NonFirstCount = add9Chords.filter(chord => chord.inversion !== 'first').length;
            
            output += '<h3>Test 3: Add9 with only first inversion selected</h3>';
            output += '<p>Generated progression:</p><ul class="chord-list">';
            progression.forEach((chord, index) => {
                output += `<li>Chord ${index + 1}: ${chord.root} ${chord.type} (${chord.inversion})</li>`;
            });
            output += '</ul>';
            
            if (add9NonFirstCount === 0) {
                output += '<p class="success">✓ PASS: All add9 chords in first inversion only</p>';
            } else {
                output += `<p class="warning">⚠ WARNING: ${add9NonFirstCount} add9 chords found in non-first inversion</p>`;
            }
            
            output += '</div>';
            document.getElementById('output').innerHTML = output;
        }

        function testMultipleProgressions() {
            let output = '<div class="test-results"><h2>Multiple Progression Test:</h2>';
            
            for (let i = 0; i < 3; i++) {
                const selectedTypes = ['major', 'minor', 'dominant7', 'major7', 'minor7', 'diminished', 'half-diminished', 'augmented', 'sus2', 'sus4', 'add9'];
                const selectedInversions = ['root', 'first', 'second'];
                const length = 6;
                
                const progression1 = generateChordProgression('C', length, selectedTypes, selectedInversions, 'Random');
                const progression2 = generateChordProgression('Am', length, selectedTypes, selectedInversions, 'Random');
                
                output += `<h3>Test Run ${i + 1}:</h3>`;
                output += `<h4>C Major:</h4><ul class="chord-list">`;
                progression1.forEach((chord, index) => {
                    output += `<li>${chord.root} ${chord.type} (${chord.inversion}) - Degree: ${chord.degreeIndex}</li>`;
                });
                output += `</ul>`;
                
                output += `<h4>A Minor:</h4><ul class="chord-list">`;
                progression2.forEach((chord, index) => {
                    output += `<li>${chord.root} ${chord.type} (${chord.inversion}) - Degree: ${chord.degreeIndex}</li>`;
                });
                output += `</ul><hr>`;
            }
            
            output += '</div>';
            document.getElementById('output').innerHTML = output;
        }

        function testRepetitionAvoidance() {
            const selectedTypes = ['major', 'minor', 'dominant7', 'major7', 'minor7', 'diminished', 'half-diminished', 'augmented', 'sus2', 'sus4', 'add9'];
            const selectedInversions = ['root', 'first', 'second'];
            const length = 12; // Longer progression to test repetition avoidance
            
            const progression = generateChordProgression('C', length, selectedTypes, selectedInversions, 'Random');
            
            // Count repetitions
            const repetitionCount = {};
            progression.forEach(chord => {
                const key = `${chord.root}-${chord.type}`;
                repetitionCount[key] = (repetitionCount[key] || 0) + 1;
            });
            
            let output = '<div class="test-results"><h2>Repetition Avoidance Test:</h2>';
            output += '<h3>Generated Progression:</h3><ul class="chord-list">';
            progression.forEach((chord, index) => {
                output += `<li>Chord ${index + 1}: ${chord.root} ${chord.type} (${chord.inversion}) - Degree: ${chord.degreeIndex}</li>`;
            });
            output += '</ul>';
            
            output += '<h3>Repetition Analysis:</h3><ul>';
            Object.entries(repetitionCount).forEach(([chord, count]) => {
                output += `<li>${chord}: ${count} time(s)</li>`;
            });
            output += '</ul></div>';
            
            document.getElementById('output').innerHTML = output;
        }
    </script>
</body>
</html>